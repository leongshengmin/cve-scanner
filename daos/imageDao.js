const dbConn = require('../services/dbConnectorService');

const TABLE_NAME = 'images';
const NAME_FIELD = 'name';
const CHILD_BLOB_SUM_FIELD = 'child_blob_sum';
const DELETED_AT_FIELD = 'deleted_at';

function getImageByName(imageName) {
  return new Promise((resolve, reject) => {
    dbConn.query(`SELECT * FROM ${TABLE_NAME} WHERE ${NAME_FIELD} = ?`, imageName, (err, rows) => {
      if (err) {
        console.error(err);
        return reject(err);
      }
      if (!rows || rows.length <= 0) {
        console.error('no rows found in res');
        return reject('no rows found in res');
      }

      return resolve(rows);
    });
  });
}

function createImage(image) {
  console.log('inserting ', image, ' into db');
  return new Promise(((resolve, reject) => {
    dbConn.query(`INSERT INTO ${TABLE_NAME}` +
      ' SET ?', image, (err, res) => {
      if (err) {
        return reject(err);
      }
      console.log('inserted image ', image, ' with row id ', res.insertId);
      return resolve(res.insertId);
    });
  }));
}

function softDeleteImage(imageName) {
  return new Promise(((resolve, reject) => {
    let setData = {};
    setData[DELETED_AT_FIELD] = new Date();

    let whereData = {};
    whereData[NAME_FIELD] = imageName;

    dbConn.query(`UPDATE ${TABLE_NAME}` +
      ' SET ? WHERE ?', [setData, whereData], (err, res) => {
      if (err) {
        return reject(err);
      }
      return resolve(res.affectedRows);
    });
  }));
}

module.exports = {
  getImageByName: getImageByName,
  createImage: createImage,
  softDeleteImage: softDeleteImage,
  TABLE_NAME: TABLE_NAME,
  NAME_FIELD: NAME_FIELD,
  CHILD_BLOB_SUM_FIELD: CHILD_BLOB_SUM_FIELD,
}